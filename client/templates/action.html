{% extends 'base.html' %}
{% load django_bootstrap5 %}
{% load static %}

{% block title %}
    {% if form.instance.pk %}
        Edit Action Item for {{client}}
    {% else %}
        New Action Item for {{client}}
    {% endif %}
{% endblock %}


{% block content %}
    {% if form.instance.pk %}
        <h1>Edit Action Item for {{client}}</h1>
    {% else %}
        <h1>New Action Item for {{client}}</h1>
    {% endif %}
{% if form.non_field_errors %}
<div class="alert alert-danger" role="alert">
    {% for error in form.non_field_errors %}
        {{ error }}
    {% endfor %}
</div>
{% endif %}
<form method="post" novalidate>
    {% csrf_token %}
    {{form.client}}
    {% bootstrap_form_errors form layout='inline' %}
    {% bootstrap_form form layout=inline %}
    <button type="submit" class="btn btn-primary">Save Action Item</button> <a href="{{ previous_url }}" class="btn btn-secondary">Cancel</a>
</form>

<script>
// 1. Move this OUTSIDE so the HTML 'onchange' can find it
// Keep this global so the 'onchange' can still find it
function updateFollowUpDate() {
    const periodSelect = document.getElementById('id_action_follow_up_period');
    const dateInput = document.getElementById('id_action_follow_up_date');
    
    // Find the Bootstrap wrapper div for the date field
    const dateWrapper = dateInput.closest('.mb-3') || dateInput.parentElement;

    if (periodSelect.value === "Other") {
        dateWrapper.style.display = 'block';
    } else {
        dateWrapper.style.display = 'none';
    }
}

document.addEventListener('DOMContentLoaded', function() {
    const actionOutcomeRadios = document.querySelectorAll('input[name="action_outcome"]');
    const periodSelect = document.getElementById('id_action_follow_up_period');
    
    // Find the Bootstrap wrapper div for the period dropdown
    const periodWrapper = periodSelect.closest('.mb-3') || periodSelect.parentElement;

    function togglePeriodDropdown() {
        let requiresFollowUp = false;
        actionOutcomeRadios.forEach(radio => {
            if (radio.checked && radio.value === "Requires Follow-Up") {
                requiresFollowUp = true;
            }
        });

        if (requiresFollowUp) {
            periodWrapper.style.display = 'block';
        } else {
            periodWrapper.style.display = 'none';
            // Hide date too if the dropdown is hidden
            const dateInput = document.getElementById('id_action_follow_up_date');
            const dateWrapper = dateInput.closest('.mb-3') || dateInput.parentElement;
            dateWrapper.style.display = 'none';
        }
        
        // Always run the "Other" check when toggling the main dropdown
        updateFollowUpDate();
    }

    actionOutcomeRadios.forEach(radio => {
        radio.addEventListener('change', togglePeriodDropdown);
    });

    // Initial run
    togglePeriodDropdown();
});
</script>


{% endblock %}