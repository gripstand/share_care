{% extends 'base.html' %}

{% load django_bootstrap5 %}

{% block title %}
Ticket For: {{ ticket.client }}
{% endblock %}

{% block content %}
{% if not ticket.ticket_open %}
    <div class="alert alert-secondary d-flex align-items-center mb-4" role="alert">
        <i class="bi bi-lock-fill me-3" style="font-size: 1.5rem;"></i>
        <div>
            <strong>This ticket is Closed.</strong> 
            Resolved on {{ ticket.ticket_resolved_date|date:"M d, Y" }} by {{ ticket.ticket_created_by }}.
        </div>
    </div>
{% endif %}
<h1>Ticket Details for {{ ticket.client }}</h1>
Ticket Short Name: {{ ticket.ticket_slug }}<br>
Ticket Created On: {{ ticket.ticket_create_date }}<br>
Ticket Created By: {{ ticket.ticket_created_by }}<br>
Ticket Issue: {{ ticket.ticket_issue }}<br>
Ticket Status: {% if ticket.ticket_open %} Open {% else %} Closed {% endif %}<br>
{% if not ticket.ticket_open %}
Ticket Resolved Date: {{ ticket.ticket_resolved_date }}<br>
{% endif %}
Ticket Associated Action: <a href="/client/action_detail/{{ticket.action.id}}">Action ID: {{ticket.action.id}}</a><br>
<br>

<h3>Ticket History</h3>
<hr>

{% for update in updates %}
    <div class="card mb-3">
        <div class="card-header d-flex justify-content-between">
            <strong>Update by: {{ update.ticket_update_by }}</strong>
            <span class="text-muted">{{ update.ticket_update_date }}</span>
        </div>
        <div class="card-body">
            <p class="card-text">{{ update.ticket_update_notes }}</p>
        </div>
        <div class="card-footer text-muted small">
            Assigned to: {{ update.ticket_assign_to }}
        </div>
    </div>
{% empty %}
    <p>No updates have been recorded for this ticket yet.</p>
{% endfor %}


<div class="mt-3">
    {% if ticket.ticket_open %}
        <a href="/client/update_ticket/{{ticket.id}}"  class="btn btn-primary">
            <i class="bi bi-plus-circle"></i> Add Update
        </a>
    {% else %}
        <button class="btn btn-secondary" disabled>
            <i class="bi bi-lock"></i> Updates Disabled (Ticket Closed)
        </button>
    {% endif %}




{% if ticket.ticket_open and request.user == ticket.ticket_created_by %}
    <form action="{% url 'close_ticket' ticket.id %}" method="post" class="d-inline">
        {% csrf_token %}
        <button type="submit" class="btn btn-danger" onclick="return confirm('Are you sure you want to resolve this ticket?')">
            <i class="bi bi-check-circle"></i> Close & Resolve Ticket
        </button>
    </form>
{% endif %}

</div>

{% endblock %}



<!-- class Ticket(models.Model):
    ticket_slug=models.CharField(max_length=30, verbose_name="Ticket Short Name")
    ticket_create_date=models.DateField(default=timezone.now)
    ticket_created_by = models.ForeignKey(
        settings.AUTH_USER_MODEL,  # Use settings.AUTH_USER_MODEL for consistency
        on_delete=models.CASCADE,
        related_name='tickets_created_by_user',
        verbose_name="Ticket created by"
    )
    ticket_issue=models.TextField(verbose_name="Issue Description")
    ticket_status=models.CharField(choices=TicketStatusTypes.choices, max_length=30, default='ACTIVE', verbose_name="Ticket Status")
    ticket_resolved_date=models.DateField(null=True, blank=True, verbose_name="Resolved Date")
    ticket_open=models.BooleanField(default=True)
    action=models.ForeignKey(Actions, on_delete=models.CASCADE, related_name='ticket_for_action')

    def __str__(self):
        return self.ticket_slug -->